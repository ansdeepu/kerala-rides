rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function getRole() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isAdmin() {
        // This is a temporary admin check. For production, use custom claims.
        return request.auth.token.email == 'ss.deepu@gmail.com';
    }

    // User profiles are readable by any signed-in user.
    // A user can create their own profile.
    // A user can only write to their own profile.
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId);
      allow update, delete: if isOwner(userId);
    }
    
    // Routes can be read by any signed-in user.
    // Admins can create/delete routes.
    // Admins can update any field on a route.
    // Any signed-in user can update the currentLocation and updatedAt fields if they are "driving".
    match /routes/{routeId} {
        allow read: if isSignedIn();
        allow create, delete: if isAdmin();
        // Admins can perform any update. Other users can only update specific fields for live tracking.
        allow update: if isAdmin() || 
                      (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['currentLocation', 'updatedAt']));
        
        // Historical trip data can be read by any signed-in user.
        // Writes are only allowed for admins or for updating actual arrival times.
        match /history/{tripId} {
            allow read: if isSignedIn();
            allow write: if isAdmin() || (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasAll(['stops']));
        }
    }
  }
}
